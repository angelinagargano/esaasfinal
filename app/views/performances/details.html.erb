<!--  app/views/movies/details.html.erb -->

<div class="event-details">
<h2>Details about <em><%= @event.name %></em></h2>
<%if logged_in? %>
  
  <% if current_user && current_user.going_events_list.include?(@event) %>
    <span class="badge bg-success mb-3">You're going!</span>

    <% if params[:show_calendar_button].present? %>
      <p><strong>Want to add this to your Google Calendar?</strong></p>
      <%= button_to "ðŸ“… Add to Google Calendar", "#", id: "add-to-calendar-btn", class: "btn btn-success" %>
    <% end %>
  <% else %>
    <%= button_to 'Going to', going_and_calendar_performance_path(@event),
        method: :post, class: 'btn btn-primary mb-3' %>
  <% end %>
<% end %>

<% if logged_in? && @friends_going.any? %>
  <h3>Friends Attending:</h3>
  <p class="description">
    <%# Render friends similar to the Description section style: inline links separated by commas %>
    <% @friends_going.each_with_index do |friend, idx| %>
      <span class="badge bg-info"><%= friend.username %></span>
    <% end %>
  </p>
<% end %>

<% if logged_in? %>
  <div class="mt-4">
    <h3>Share Event</h3>
    
    <!-- Share via Message -->
    <div class="mb-3">
      <h4>Share via Message</h4>
      <%= form_with url: share_to_message_performance_path(@event), method: :post, local: true do |f| %>
        <%# Get all accepted friends %>
        <% friends = current_user.all_friends %>
        
        <% if friends.any? %>
          <div class="mb-2">
            <%= select_tag :friend_id, options_from_collection_for_select(friends, :id, :username), 
                { prompt: "Select a friend", class: "form-select" } %>
          </div>
          
          <div class="mb-2">
            <%= text_area_tag :message, "Check out this event!", class: "form-control", rows: 2, placeholder: "Add a message (optional)" %>
          </div>
          
          <%= f.submit "Share via Message", class: "btn btn-primary" %>
        <% else %>
          <p class="text-muted">You need friends to share events. <%= link_to "Find friends", find_friends_search_path %></p>
        <% end %>
      <% end %>
    </div>
    
    <!-- Share with Groups -->
    <div class="mb-3">
      <h4>Share with Groups</h4>
      <% user_groups = current_user.groups.includes(:members) %>
      <% if user_groups.any? %>
        <% user_groups.each do |group| %>
          <%= form_with url: group_group_conversation_group_messages_path(group), method: :post, local: true do |f| %>
            <%= hidden_field_tag "group_message[content]", "Check out this event!" %>
            <%= hidden_field_tag "event_ids[]", @event.id %>
            <%= f.submit "Share with #{group.name}", class: "btn btn-sm btn-secondary mb-2" %>
          <% end %>
        <% end %>
      <% else %>
        <p class="text-muted">You're not in any groups. <%= link_to "Create a group", new_group_path %></p>
      <% end %>
    </div>
  </div>
<% end %>

<script>
  document.addEventListener("click", function(e) {
    if (e.target.id === "add-to-calendar-btn") {
      e.preventDefault();

      const googleUrl =
        "https://www.google.com/calendar/render?action=TEMPLATE" +
        "&text=<%= URI.encode_www_form_component(@event.name) %>" +
        "&dates=<%= DateTime.parse(@event.date + ' ' + @event.time).strftime('%Y%m%dT%H%M%S') %>/<%= (DateTime.parse(@event.date + ' ' + @event.time) + 2.hours).strftime('%Y%m%dT%H%M%S') %>" +
        "&details=<%= URI.encode_www_form_component(@event.description || 'Join me for this event!') %>" +
        "&location=<%= URI.encode_www_form_component(@event.location) %>";

      window.open(googleUrl, "_blank");
    }
  });
</script>
<ul id="details">
  <li>
    Date:
    <%= @event.date %>
  </li>
  <li>
    Time:
    <%= @event.time %>
  </li>
  <li>
    Price:
    <%= @event.price %>
  </li>
  <li>
    Venue:
    <%= @event.venue %>
  </li>
  <li>
    Location:
    <%= @event.location %>
  </li>
  <li>
    Borough:
    <%= @event.borough %>
  </li>
  <li>
    Style:
    <%= @event.style %>
  </li>
</ul>

<h3>Description:</h3>
<p id="description">
  <%= @event.description %>
</p>

<div class="mt-4 d-flex">
  <%= link_to 'Back to Home', performances_path, class: 'btn btn-secondary mr-3'  %>
  <% if @event.tickets.present? %>
    <%= link_to 'Purchase Tickets', @event.tickets, class: 'btn btn-primary', target: '_blank', rel: 'noopener', allow_other_host: true %>
  <% end %>
</div>
</div>